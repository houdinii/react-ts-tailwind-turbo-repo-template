# .github/workflows/first-run.yml
name: ğŸ”§ Firstâ€‘run â€“ personalise template
on:
  push:
    branches: [ main, master ]          # default branch of the *generated* repo
    paths: [ ".github/workflows/first-run.yml" ]   # runs only once

jobs:
  rename:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸  Check out code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1.  Derive values from repo URL
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - id: vars
        name: ğŸ”  Derive repo/user names
        run: |
          full="${{ github.repository }}"     # e.g. houdinii/my-new-project
          user="${full%%/*}"                  # "houdinii"
          repo="${full##*/}"                  # "my-new-project"
          
          echo "repoName=${repo}"    >> "$GITHUB_OUTPUT"
          echo "projectName=${repo}" >> "$GITHUB_OUTPUT"
          echo "userName=${user}"    >> "$GITHUB_OUTPUT"
          echo "scope=@${repo}"      >> "$GITHUB_OUTPUT"
          echo "lib=ui"              >> "$GITHUB_OUTPUT"   # change if needed

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2.  Replace all placeholders
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœï¸  Replace {{tokens}}
        env:
          repoName: ${{ steps.vars.outputs.repoName }}
          projectName: ${{ steps.vars.outputs.projectName }}
          userName: ${{ steps.vars.outputs.userName }}
          scope: ${{ steps.vars.outputs.scope }}
          lib: ${{ steps.vars.outputs.lib }}
        run: |
          # Build the sed script just once
          SED_SCRIPT=$(cat <<'EOF'
          s/{{repoName}}/${repoName}/g;
          s/{{projectName}}/${projectName}/g;
          s/{{userName}}/${userName}/g;
          s/{{scope}}\/{{lib}}/${scope//\//\\/}\/${lib}/g
          EOF
          )
      
          # â”€â”€ list *tracked* files, exclude generated dirs, feed to sed â”€â”€
          git ls-files -z \
          | grep -zvE '(^|/)dist/' \
          | xargs -0 sed -i -e "$SED_SCRIPT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3.  Remove this workflow file
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¹  Delete self
        run: rm .github/workflows/first-run.yml

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4.  Commit & push rename
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦  Commit updated files
        run: |
          git config user.name  "templateâ€‘bot"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          git commit -m "chore: initial project rename" || echo "No changes"
          git push
