
# .github/workflows/first-run.yml
name: ğŸ”§ First-run â€“ personalise template
on:
  push:
    branches: [ main, master ]
    paths:   [ ".github/workflows/first-run.yml" ]   # runs only once

jobs:
  rename:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: vars
        run: |
          full="${{ github.repository }}"      # houdinii/my-new-project
          echo "repoName=${full##*/}"          >> "$GITHUB_OUTPUT"
          echo "projectName=${full##*/}"       >> "$GITHUB_OUTPUT"
          echo "userName=${full%%/*}"          >> "$GITHUB_OUTPUT"
          echo "scope=@${full%%/*}"            >> "$GITHUB_OUTPUT"
          echo "lib=ui"                        >> "$GITHUB_OUTPUT"

      # â”€â”€ patched replace step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœï¸  Replace {{tokens}}
        env:
          repoName:    ${{ steps.vars.outputs.repoName }}
          projectName: ${{ steps.vars.outputs.projectName }}
          userName:    ${{ steps.vars.outputs.userName }}
          scope:       ${{ steps.vars.outputs.scope }}
          lib:         ${{ steps.vars.outputs.lib }}
        run: |
          #   1. build a oneâ€‘liner Perl programme
          #   2. run it on every tracked file (except dist/)
          PERL_SCRIPT='
            s/\{\{repoName}}/\Q$ENV{repoName}\E/g;
            s/\{\{projectName}}/\Q$ENV{projectName}\E/g;
            s/\{\{userName}}/\Q$ENV{userName}\E/g;
            s/\{\{scope}}\/\{\{lib}}/\Q$ENV{scope}\/$ENV{lib}\E/g;
          '
          
          git ls-files -z | grep -zvE '(^|/)dist/' \
            | xargs -0 perl -0777 -pi -e "$PERL_SCRIPT"

      - name: ğŸ§¹  Delete self
        run: rm .github/workflows/first-run.yml

      - name: ğŸ“¦  Commit updates
        run: |
          git config user.name  template-bot
          git config user.email actions@users.noreply.github.com
          git add -A
          git commit -m "chore: initial project rename" || echo "No changes"
          git push
